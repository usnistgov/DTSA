 {[j=30/55,:+,u+,r+,o=120,k+,n+,#+,v+,q+,b+]}{[f-]} {*********************************} UNIT Choices;{*********************************}{**********************************} INTERFACE {**********************************} USES QuickDraw, Types, OSUtils, ToolUtils, Timer, Errors, Menus, Files, Lists, Memory,   Packages, Printing, StandardFile, PasLibIntf, fenv, fp, Retrace, SegLoad,  Spectrum_Structures, Declarations, INITIALIZE, Global_Functions, Utilities,  Xray_Energies, SANDIA, Physics, xray ; PROCEDURE Spectrum_Choice(Choice: LongInt; Spectrum: Integer);{******************************} IMPLEMENTATION {**********************************}{$S Choices}  PROCEDURE Spectrum_Choice(Choice: LongInt; Spectrum: Integer); { 10 is work and 9 is results }    VAR      nn, kk, i, Number_of_Elements					: Integer;      Av_BackScatter, U_Inc, U_Lim, kiloV          	: Real;      Av_StoppingPower, edge_engy, e_ener_Sq        : Real;	PROCEDURE Attach_Generated_Parameters(Spectrum : Integer);	VAR 	  nn : integer;	   Begin		           Plt_Spec[Spectrum]^^.Expt_Info.Mylar := theGenRec^^.Mylar; { these 4 have the same name.... SMART }         Plt_Spec[Spectrum]^^.Expt_Info.Moxtek := theGenRec^^.Moxtek;         Plt_Spec[Spectrum]^^.Expt_Info.Paralene := theGenRec^^.Paralene;         Plt_Spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Take_Off_Angle := theGenRec^^.Take_Off_Angle;         IF Running_Thin_Mode THEN 		  Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Thickness := Specimen_Thickness ;		           Plt_spec[Spectrum]^^.SpectrumStuff.Acq_Info.Live_Time := Live_Time; 		 WITH Plt_spec[Spectrum]^^,SpectrumStuff, Spectrum_Info, Expt_Info, Acq_Info DO		 BEGIN		  Theoretically_Generated := True;		  BN_Thickness := theGenRec^^.BN_Thickness;		  SiN_Thickness := theGenRec^^.SiN_Thickness;		  Spec_Detector_Distance := theGenRec^^.Spec_Detector_Distance;		  Detector_Area := theGenRec^^.Detector_Area;		  Si_Resolution := theGenRec^^.Si_Resolution;		  WDS_Resolution := theGenRec^^.WDS_Resolution;		  Detector_Thickness := theGenRec^^.Detector_Thickness;		  Si_Thickness := theGenRec^^.Si_Thickness;		  Au_Thickness := theGenRec^^.Au_Thickness;		  Be_Thickness := theGenRec^^.Be_Thickness;		  Ice_Thickness := theGenRec^^.Ice_Thickness;		  C_Thickness := theGenRec^^.C_Thickness;		  Al_Thickness := theGenRec^^.Al_Thickness;		  detector.spec := theGenRec^^.detector.spec;		  detector.ID := theGenRec^^.detector.ID;		  		  IF Running_Thin_Mode THEN kV := Thin_KV ;		  IF Running_Bulk_Mode THEN kV := Bulk_KV ;		  		  IF Running_Thin_Mode THEN Specimen_Density := Thin_density ELSE Specimen_Density := 1.0 ;		  Begin_Faraday := Faraday_Current;		  End_Faraday := Faraday_Current; 			FOR nn := 1 TO 15 DO			  BEGIN		 				IF Running_Thin_Mode THEN Element_Info[nn].Atomic_number := A^.Thin_At_Num[nn] ;				IF Running_Bulk_Mode THEN Element_Info[nn].Atomic_number := A^.Bulk_At_Num[nn] ;				IF Running_Thin_Mode THEN Element_Info[nn].Weight_Fraction := A^.Thin_Concentration[nn] ;				IF Running_Bulk_Mode THEN Element_Info[nn].Weight_Fraction := A^.Bulk_Concentration[nn] ;				IF Running_Thin_Mode THEN Element_Info[nn].valence := A^.Thin_valence[nn] ;				IF Running_Bulk_Mode THEN Element_Info[nn].valence := A^.Bulk_valence[nn] ;			  END;		  END; { With...}	   end;     BEGIN      { Do some preliminary house keeping }		 if NOT (SiLi_Response_Calculated) then		    Detector_Efficiency(theGenRec,SiLi_Response_Calculated);	  		{also sets Gen_responseFnc = to Qhdl^^.det_effic}	        IF (Choice <= 100) AND (Choice >= 0)        THEN          BEGIN                                       { A very very long way down will be an else }            SpinCursor;            For nn := 1 to Maximum_Channels do col_1^[nn] := 0.0;            (********************** ITEMS VERSUS ATOMIC NUMBER *****************)   IF (Choice <= 64) AND (Choice >= 1)        THEN          BEGIN            FOR nn := 4 TO 94 DO              BEGIN                Get_Energies(nn);                     { Get edge energies etc, for atomic number nn                                                       }                SpinCursor;                CASE Choice OF                  1:                    BEGIN                             { Qk vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Qk(Thin_KV, A^.edge[1]) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Qk(Bulk_KV, A^.edge[1]) * 1.0E20;                    END;                              { If Choice = 1 }                  2:                    BEGIN                             { Ql vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Ql(Thin_KV, A^.edge[4]) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Ql(Bulk_KV, A^.edge[4]) * 1.0E20;                    END;                              { If Choice = 2 }                  3:                    BEGIN                             { Qm vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Qm(Thin_KV, A^.edge[9]) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Qm(Bulk_KV, A^.edge[9]) * 1.0E20;                    END;                              { If Choice = 3 }                  4:                    BEGIN                             { vs Z }                      IF Running_Thin_Mode                        THEN                          BEGIN                          END;                      IF Running_Bulk_Mode                        THEN                          BEGIN                          END;                    END;                              { If Choice = 4 }                  5:                    BEGIN                             { Qk*F*Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Qk(Thin_KV, A^.edge[1]) * Wk(nn) * SAK(nn) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Qk(Bulk_KV, A^.edge[1]) * Wk(nn) * SAK(nn) * 1.0E20;                    END;                              { If Choice = 5 }                  6:                    BEGIN                             { Ql*F*Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Ql(Thin_KV, A^.edge[4]) * Wl(nn) * SAL(nn) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Ql(Bulk_KV, A^.edge[4]) * Wl(nn) * SAL(nn) * 1.0E20;                    END;                              { If Choice = 6 }                  7:                    BEGIN                             { Qm*F*Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Qm(Thin_KV, A^.edge[9]) * Wm(nn) * SAM(nn) * 1.0E20;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Qm(Bulk_KV, A^.edge[9]) * Wm(nn) * SAM(nn) * 1.0E20;                    END;                              { If Choice = 7 }                  8:                    BEGIN                             { Qk*F*Omega/A vs Z }                      IF Running_Thin_Mode                        THEN                          col_1^[nn] := Qk(Thin_KV, A^.edge[1]) * Wk(nn) * SAK(nn) / Atomic_Weight * 1.0E20;                      IF Running_Bulk_Mode                        THEN                          col_1^[nn] := Qk(Bulk_KV, A^.edge[1]) * Wk(nn) * SAK(nn) / Atomic_Weight * 1.0E20;                    END;                              { If Choice = 8 }                  9:                    BEGIN                             { Ql*F*Omega/A vs Z }                      IF Running_Thin_Mode                        THEN                          col_1^[nn] := Ql(Thin_KV, A^.edge[4]) * Wl(nn) * SAL(nn) / Atomic_Weight * 1.0E20;                      IF Running_Bulk_Mode                        THEN                          col_1^[nn] := Ql(Bulk_KV, A^.edge[4]) * Wl(nn) * SAL(nn) / Atomic_Weight * 1.0E20;                    END;                              { If Choice = 9 }                  10:                    BEGIN                             { Qm*F*Omega/A vs Z }                      IF Running_Thin_Mode                        THEN                          col_1^[nn] := Qm(Thin_KV, A^.edge[9]) * Wm(nn) * SAM(nn) / Atomic_Weight * 1.0E20;                      IF Running_Bulk_Mode                        THEN                          col_1^[nn] := Qm(Bulk_KV, A^.edge[9]) * Wm(nn) * SAM(nn) / Atomic_Weight * 1.0E20;                    END;                              { If Choice = 10 }                  11:                    BEGIN                             { Fk vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := SAK(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := SAK(nn);                    END;                              { If Choice = 11 }                  12:                    BEGIN                             { Fl vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := SAL(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := SAL(nn);                    END;                              { If Choice = 12 }                  13:                    BEGIN                             { Fm vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := SAM(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := SAM(nn);                    END;                              { If Choice = 13 }                  14:                    BEGIN                             { Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Wk(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Wk(nn);                    END;                              { If Choice = 14 }                  15:                    BEGIN                             { Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Wl(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Wl(nn);                    END;                              { If Choice = 15 }                  16:                    BEGIN                             { Omega vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Wm(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Wm(nn);                    END;                              { If Choice = 16 }                  17:                    BEGIN                             { Atomic_Weight vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Atomic_Weight;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Atomic_Weight;                    END;                              { If Choice = 17 }                  18:                    BEGIN                             { J vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := J_Factor(nn);                      IF Running_Bulk_Mode                        THEN col_1^[nn] := J_Factor(nn);                    END;                              { If Choice = 18 }                  19:                    BEGIN                             { J/Z vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := J_Factor(nn) / nn;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := J_Factor(nn) / nn;                    END;                              { If Choice = 19 }                  20:                    BEGIN                             { Integrate_Qk_over_S vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := zero;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Integrate_Q_over_S(1);                    END;                              { If Choice = 20 }                  21:                    BEGIN                             { Integrate_Ql_over_S vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := zero;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Integrate_Q_over_S(2);                    END;                              { If Choice = 21 }                  22:                    BEGIN                             { Integrate_Qm_over_S vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := zero;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Integrate_Q_over_S(3);                    END;                              { If Choice = 21 }                  23:                    BEGIN                             { minus Stopping Power vs Z evaluated at the                                                       beam energy }                      IF Running_Thin_Mode                        THEN col_1^[nn] := - Stopping_Power(Thin_KV); { E in keV }                      IF Running_Bulk_Mode                        THEN col_1^[nn] := - Stopping_Power(Bulk_KV); { E in keV }                    END;                              { If Choice = 23 }                  24:                    BEGIN                             { vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := 1;     { }                      IF Running_Bulk_Mode                        THEN col_1^[nn] := 1;     { }                    END;                              { If Choice = 24 }                  25:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := 1;     { }                      IF Running_Bulk_Mode                        THEN col_1^[nn] := 1;     { }                    END;                              { If Choice = 25 }                  26:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := 1;     { }                      IF Running_Bulk_Mode                        THEN col_1^[nn] := 1;     { }                    END;                              { If Choice = 26 }                  27:                    BEGIN                             { Element_Density vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Element_Density;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Element_Density;                    END;                              { If Choice = 27 }                  28:                    BEGIN                             { Z/Atomic_Weight vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Z / Atomic_Weight;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Z / Atomic_Weight;                    END;                              { If Choice = 28 }                  29:                    BEGIN                             { Z*Z/Atomic_Weight vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := Z * Z / Atomic_Weight;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := Z * Z / Atomic_Weight;                    END;                              { If Choice = 29 }                  30:                    BEGIN                             { A^.edge[ 1 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[1];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[1];                    END;                              { If Choice = 30 }                  31:                    BEGIN                             { A^.edge[ 2 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[2];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[2];                    END;                              { If Choice = 31 }                  32:                    BEGIN                             { A^.edge[ 3 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[3];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[3];                    END;                              { If Choice = 32 }                  33:                    BEGIN                             { A^.edge[ 4 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[4];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[4];                    END;                              { If Choice = 33 }                  34:                    BEGIN                             { A^.edge[ 5 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[5];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[5];                    END;                              { If Choice = 34 }                  35:                    BEGIN                             { A^.edge[ 6 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[6];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[6];                    END;                              { If Choice = 35 }                  36:                    BEGIN                             { A^.edge[ 7 ] vs Z }                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[7];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[7];                    END;                              { If Choice = 36 }                  { A^.edge[ 8 ] vs Z }                  37:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[8];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[8];                    END;                              { If Choice = 37 }                  { A^.edge[ 9 ] vs Z }                  38:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[9];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[9];                    END;                              { If Choice = 38 }                  { eV_KA1 vs Z }                  39:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[1];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[1];                    END;                              { If Choice = 39 }                  { eV_KA2 vs Z }                  40:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[2];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[2];                    END;                              { If Choice = 40 }                  { eV_KB1 vs Z }                  41:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[3];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[3];                    END;                              { If Choice = 41 }                  { eV_LA1 vs Z }                  42:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[42];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[42];                    END;                              { If Choice = 42 }                  { eV_LB1 vs Z }                  43:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[29];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[29];                    END;                              { If Choice = 43 }                  { eV_LB2 vs Z }                  44:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[45];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[45];                    END;                              { If Choice = 44 }                  { eV_LB3 vs Z }                  45:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[14];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[14];                    END;                              { If Choice = 45 }                  { eV_LB4 vs Z }                  46:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[15];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[15];                    END;                              { If Choice = 46 }                  { eV_LG1 vs Z }                  47:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[17];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[17];                    END;                              { If Choice = 47 }                  { eV_LG3 vs Z }                  48:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[18];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[18];                    END;                              { If Choice = 48 }                  { eV_LL vs Z }                  49:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[49];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[49];                    END;                              { If Choice = 49 }                  { eV_Leta vs Z }                  50:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[35];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[35];                    END;                              { If Choice = 50 }                  { eV_MA1_2 vs Z }                  51:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[72];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[72];                    END;                              { If Choice = 51 }                  { eV_MB vs Z }                  52:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[69];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[69];                    END;                              { If Choice = 52 }                  { eV_MG vs Z }                  53:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[66];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[66];                    END;                              { If Choice = 53 }                  { eV_MZ1  vs Z }                  54:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[74];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[74];                    END;                              { If Choice = 54 }                  { eV_M2N4 vs Z }                  55:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[57];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[57];                    END;                              { If Choice = 55 }                  { M3N1 vs Z }                  56:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := eV_Line[61];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := eV_Line[61];                    END;                              { If Choice = 56 }                  { 1 vs Z }                  57:                    BEGIN                      IF Running_Thin_Mode                        THEN                          BEGIN                            col_1^[nn] := 1;                          END;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := 1;                    END;                              { If Choice = 57 }                  { KA1 Pk/Local BG vs Z }                  58:                    BEGIN                      IF Running_Thin_Mode                        THEN                          BEGIN                            K_Peak_2_Bkg := True;                            L_Peak_2_Bkg := False;                            M_Peak_2_Bkg := False;                            IF (rinttol(eV_Line[1] / Plt_spec[10]^^.Expt_Info.dE) <= theGenRec^^.number_of_Channels) AND 							   (rinttol(eV_Line[1] / Plt_spec[10]^^.Expt_Info.dE) >= 5)                              THEN                                BEGIN                                  Q_Continuum_Thin(nn);                                  col_1^[nn] := Bkg_P^[nn];                                  col_1^[nn] := Qk(Thin_KV, A^.edge[1]) * Wk(nn) * SAK(nn) /                                                    (Atomic_Weight);                                  col_1^[nn] := col_1^[nn] / Bkg_P^[rinttol(eV_Line[1] /                                                    Plt_spec[10]^^.Expt_Info.dE)];                                END                              ELSE col_1^[nn] := zero;                          END;                      IF Running_Bulk_Mode                        THEN                          BEGIN                          END;                    END;                              { If Choice = 58 }                  { LA1 Pk/Local BG vs Z }                  59:                    BEGIN                      IF Running_Thin_Mode                        THEN                          BEGIN                            K_Peak_2_Bkg := False;                            L_Peak_2_Bkg := True;                            M_Peak_2_Bkg := False;                            IF (rinttol(eV_Line[42] / Plt_spec[10]^^.Expt_Info.dE) <= theGenRec^^.number_of_Channels) AND 							   (rinttol(eV_Line[42] / Plt_spec[10]^^.Expt_Info.dE) >= 5)                              THEN                                BEGIN                                  Q_Continuum_Thin(nn);                                  col_1^[nn] := Bkg_P^[nn];                                  col_1^[nn] := Ql(Thin_KV, A^.edge[4]) * Wl(nn) * SAL(nn) /                                                    (Atomic_Weight);                                  col_1^[nn] := col_1^[nn] / Bkg_P^[rinttol(eV_Line[42] /                                                    Plt_spec[10]^^.Expt_Info.dE)];                                END                              ELSE col_1^[nn] := zero;                          END;                      IF Running_Bulk_Mode                        THEN                          BEGIN                          END;                    END;                              { If Choice = 59 }                  { MA1 Pk/Local BG vs Z }                  60:                    BEGIN                      IF Running_Thin_Mode                        THEN                          BEGIN                            K_Peak_2_Bkg := False;                            L_Peak_2_Bkg := False;                            M_Peak_2_Bkg := True;                            IF (rinttol(eV_Line[72] / Plt_spec[10]^^.Expt_Info.dE) <= theGenRec^^.number_of_Channels) AND 							   (rinttol(eV_Line[72] / Plt_spec[10]^^.Expt_Info.dE) >= 5)                              THEN                                BEGIN                                  Q_Continuum_Thin(nn);                                  col_1^[nn] := Bkg_P^[nn];                                  col_1^[nn] := Qm(Thin_KV, A^.edge[9]) * Wm(nn) * SAM(nn) /                                                    (Atomic_Weight);                                  col_1^[nn] := col_1^[nn] / Bkg_P^[rinttol(eV_Line[72]                                                    / Plt_spec[10]^^.Expt_Info.dE)];                                END                              ELSE col_1^[nn] := zero;                          END;                      IF Running_Bulk_Mode                        THEN                          BEGIN                          END;                    END;                              { If Choice = 60 }										                                    61:          { A^.edge[ 10 ] vs Z }                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := A^.edge[10];                      IF Running_Bulk_Mode                        THEN col_1^[nn] := A^.edge[10];                    END;                              { If Choice = 61 }					                  62:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := RHO_Handle^^.Value[ nn ] ;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := RHO_Handle^^.Value[ nn ] ;                    END;                              { If Choice = 62 }                  63:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := nn/At_Wt^^.Value [ nn ] ;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := nn/At_Wt^^.Value [ nn ] ;                    END;                              { If Choice = 63 }                  64:                    BEGIN                      IF Running_Thin_Mode                        THEN col_1^[nn] := nn * nn /At_Wt^^.Value [ nn ] ;                      IF Running_Bulk_Mode                        THEN col_1^[nn] := nn * nn /At_Wt^^.Value [ nn ] ;                    END;                              { If Choice = 64 }                END;                                  { CASE Choice OF.... }              END;                                    { ITEMS VERSUS ATOMIC NUMBER, nn loop }            { A final cleanup task for the atomic number loop }            FOR nn := 1 TO 3 DO col_1^[nn] := zero;            FOR nn := 94 TO theGenRec^^.number_of_Channels DO col_1^[nn] := zero;         END; { if choice between 1 and 64 }                    { If Choice = 65   QkEk^2 vs U}                  If Choice = 65 then                  	BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF Running_Bulk_Mode AND (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1                            ELSE IF Running_Thin_Mode AND (A^.Thin_Concentration[kk] <> 0.0) AND (A^.Thin_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                      IF i = 1 then begin                      	  IF Running_Bulk_Mode then Z := A^.Bulk_At_Num[1]                      	  ELSE IF Running_Thin_Mode then Z := A^.Thin_At_Num[1];                      	  Get_Energies(Z);                  	  	  edge_engy := A^.edge[1];                  	  	  e_ener_Sq :=SQR(edge_engy);                  	  	  U_Lim := edge_engy/1000.0;                  	  	  U_Inc := U_Lim/100;                  	  	  U_Lim := U_Lim - U_Inc;                  	  FOR nn := 1 TO 4000 DO BEGIN	                  	  U_Lim := U_Lim + U_Inc;	                      col_1^[nn + 99] := Qk(U_Lim, edge_engy) * e_ener_Sq * 1.0E14;	{cm^2eV^2}	                  END;	                  	                  end;                    END;                              { If Choice = 65 }                    { If Choice = 66   QlEl^2 vs U}                  If Choice = 66 then                  	BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF Running_Bulk_Mode AND (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1                            ELSE IF Running_Thin_Mode AND (A^.Thin_Concentration[kk] <> 0.0) AND (A^.Thin_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                      IF i = 1 then begin                      	  IF Running_Bulk_Mode then Z := A^.Bulk_At_Num[1]                      	  ELSE IF Running_Thin_Mode then Z := A^.Thin_At_Num[1];                      	  Get_Energies(Z);                  	  	  edge_engy := A^.edge[4];                  	  	  e_ener_Sq :=SQR(edge_engy);                  	  	  U_Lim := edge_engy/1000.0;                  	  	  U_Inc := U_Lim/100;                  	  	  U_Lim := U_Lim - U_Inc;                  	  FOR nn := 1 TO 4000 DO BEGIN	                  	  U_Lim := U_Lim + U_Inc;	                      col_1^[nn + 99] := Ql(U_Lim, edge_engy) * e_ener_Sq * 1.0E14;	{cm^2eV^2}	                  END;	                  	                  end;                    END;                              { If Choice = 66 }                    { If Choice = 67   QmEm^2 vs U}                  If Choice = 67 then                  	BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF Running_Bulk_Mode AND (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1                            ELSE IF Running_Thin_Mode AND (A^.Thin_Concentration[kk] <> 0.0) AND (A^.Thin_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                      IF i = 1 then begin                      	  IF Running_Bulk_Mode then Z := A^.Bulk_At_Num[1]                      	  ELSE IF Running_Thin_Mode then Z := A^.Thin_At_Num[1];                      	  Get_Energies(Z);                  	  	  edge_engy := A^.edge[9];                  	  	  e_ener_Sq :=SQR(edge_engy);                  	  	  U_Lim := edge_engy/1000.0;                  	  	  U_Inc := U_Lim/100;                  	  	  U_Lim := U_Lim - U_Inc;                  	  FOR nn := 1 TO 4000 DO BEGIN	                  	  U_Lim := U_Lim + U_Inc;	                      col_1^[nn + 99] := Qm(U_Lim, edge_engy) * e_ener_Sq * 1.0E14;	{cm^2eV^2}	                  END;	                  	                  end;                    END;                              { If Choice = 67 }			                if Choice = 70 then { make a ramp }					 FOR nn := 1 TO theGenRec^^.number_of_Channels DO col_1^[nn] := nn;						                                                 { If Choice = 70 }					       (* 본본본본본본본본본본본본본본 ITEMS VERSUS PHOTON ENERGY 본본본본본본본본본본본본본본본본 *)        IF (Choice <= 100) AND (Choice >= 80)        THEN          BEGIN            CASE Choice OF                          80:               { Detector Response vs E }                BEGIN				  BlockMove(@Det_Effic_P^, @Col_1^, Sizeof(Col_1^));                END;                                  { If Choice = 80 }                            81:                 { Detector Response after Electronics }                BEGIN				  BlockMove(@Det_Effic_P^, @Col_1^, Sizeof(Col_1^));                  Convolve_Col1;                END;                                  { If Choice = 81 }                            82:                { Continuum after Electronics }                BEGIN                                        IF Running_Thin_Mode then 					  (*FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := Bkg_P^[nn] * Det_Effic_P^[nn] / (Pi4);	*)					                          {No Pi4...Brem is per unit steradian}					   BlockMove(@col_5^, @Col_1^, Sizeof(col_5^));						(*col_1^[nn] := Bkg_P^[nn] * Det_Effic_P^[nn];	*)					   											                         IF Running_Bulk_Mode then 					  	BlockMove(@col_4^, @Col_1^, Sizeof(col_4^));					  (*FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := col_4^[nn] ;*) {...with Pi4}					 					(*Convolve_Col1;*)	  			    Add_Escape_Peaks;                 END;                                  { If Choice = 82 }                             83:                BEGIN                  FOR nn := 1 TO theGenRec^^.number_of_Channels DO col_1^[nn] := one;                END;                                  { If Choice = 83 }                             84:            { Generated Spectrum inside specimen = cont + deltas }                BEGIN                  (*FOR nn := 1 TO theGenRec^^.number_of_Channels DO                     col_1^[nn] := col_2^[nn];*)					BlockMove(@col_2^, @Col_1^, Sizeof(col_2^));                END;                                                               85:                      { Detected Gaussians vs E }                BEGIN                  (*FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := Ob_Pks_P^[nn];*)					BlockMove(@Ob_Pks_P^, @Col_1^, Sizeof(Ob_Pks_P^));                END;                                                                                                                                                         86:                     { spectrum before detector  }                BEGIN                                                                 IF Running_Thin_Mode then BlockMove(@col_4^,@col_1^,SizeOf(col_4^));{with absorp}                      IF Running_Bulk_Mode then BlockMove(@col_6^,@col_1^,SizeOf(col_6^));                END;                                                                                                  87:                     { spectrum inside detector  }                BEGIN 					BlockMove(@col_3^,@col_1^,SizeOf(col_3^));                END;                                  { If Choice = 87 }                            88:                   { mu/rho vs E }                BEGIN                  BlockMove(@mu_rho_P^,@col_1^,SizeOf(mu_rho_P^));                END;                                  { If Choice = 88 }                            89:               { f of chi vs E }                BEGIN                                        IF Running_Thin_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := zero;                      IF Running_Bulk_Mode then 						BlockMove(@f_chi_P^,@col_1^,SizeOf(f_chi_P^));                END;                                                                90:                    BEGIN                      IF Running_Thin_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := Bkg_P^[nn] * Atomic_Weight / 						                       (DOMEGA * Thin_Physics_Constant);                      IF Running_Bulk_Mode then                        BlockMove(@Bkg_P^,@col_1^,SizeOf(Bkg_P^));	{ Actual Q for continuum }                    END;                             91:                BEGIN                  { if Running_Thin_Mode then   ;}                  IF Running_Bulk_Mode                    THEN                      BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                        Number_of_Elements := i;                        FOR nn := 1 TO theGenRec^^.number_of_Channels DO                          BEGIN                            Av_BackScatter := zero;                            SpinCursor;                            FOR kk := 1 TO Number_of_Elements DO                              BEGIN                                Get_Energies(A^.Bulk_At_Num[kk]);                                Av_BackScatter := A^.Bulk_Concentration[kk] * BackScatter(nn *                                                  Plt_spec[10]^^.Expt_Info.dE / 1000) + Av_BackScatter;                              END;                            col_1^[nn] := Av_BackScatter;                          END;                      END;                END;                                  { If Choice = 91 }                            92:                        { Continuum Back Scatter vs E }                BEGIN                  IF Running_Bulk_Mode                    THEN                      BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                        Number_of_Elements := i;                        FOR nn := 1 TO theGenRec^^.number_of_Channels DO                          BEGIN                            Av_BackScatter := zero;                            SpinCursor;                            FOR kk := 1 TO Number_of_Elements DO                              BEGIN                                Get_Energies(A^.Bulk_At_Num[kk]);                                Av_BackScatter := A^.Bulk_Concentration[kk] * Continuum_Backscatter(nn                                                  * Plt_spec[10]^^.Expt_Info.dE / 1000) + Av_BackScatter;                              END;                            col_1^[nn] := Av_BackScatter;                          END;                      END;                            { if running bulk mode }                END;                                  { If Choice = 92 }                            93:                            { Stopping Power vs E }                BEGIN                  IF Running_Bulk_Mode                    THEN                      BEGIN                        i := 0;                        FOR kk := 1 TO 10 DO                          BEGIN                            IF (A^.Bulk_Concentration[kk] <> 0.0) AND (A^.Bulk_At_Num[kk] <> 0)                              THEN i := i + 1;                          END;                        Number_of_Elements := i;                        FOR nn := 1 TO theGenRec^^.number_of_Channels DO                          BEGIN                            Av_StoppingPower := zero;                            SpinCursor;                            FOR kk := 1 TO Number_of_Elements DO                              BEGIN                                Get_Energies(A^.Bulk_At_Num[kk]);                                Av_StoppingPower := A^.Bulk_Concentration[kk] * Stopping_Power(nn *                                                    Plt_spec[10]^^.Expt_Info.dE / 1000) +													Av_StoppingPower;                              END;                            col_1^[nn] := Av_StoppingPower;                          END;                      END;                            { if running bulk mode }                END;                                  { If Choice = 93 }                                           94:    { Thin film spectrum in front of detector with specimen only absorption applied }                BEGIN                     (* IF Running_Thin_Mode then 					  BlockMove(@Gen_P^,@col_1^,SizeOf(Gen_P^));*)                      IF Running_Bulk_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := zero;                END;                                  { If Choice = 94 }              95:                BEGIN           { Thin film continuum with absorptions applied }                                        IF Running_Thin_Mode then 					    BlockMove(@col_5^,@col_1^,SizeOf(col_5^));                      IF Running_Bulk_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO                        col_1^[nn] := zero;                END;                                  { If Choice = 95 }                             96:                BEGIN                      IF Running_Thin_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO							col_1^[nn] := (Bkg_P^[nn] / 								 (DOMEGA * Thin_Physics_Constant) ) * Atomic_Weight *								 (nn*Plt_spec[10]^^.Expt_Info.dE)/(Z*Z) ;                      IF Running_Bulk_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO                          col_1^[nn] := zero ;                END;                                   				              97:                     { spectrum before detector w/o fluorescence  }                BEGIN					  IF Running_Thin_Mode then FOR nn := 1 TO theGenRec^^.number_of_Channels DO					    col_1^[nn] := zero ;                      IF Running_Bulk_Mode then BlockMove(@col_5^,@col_1^,SizeOf(col_1^));                END;                                                 98:            { Generated Spectrum inside specimen }                BEGIN                  FOR nn := 1 TO theGenRec^^.number_of_Channels DO                     col_1^[nn] := col_2^[nn]* Pi4 / Domega ;                END;                                                 { Final composite spectrum vs E }              100:                BEGIN										BlockMove(@Composite_P^,@col_1^,SizeOf(Composite_P^));						                END;                                  { If Choice = 100 }            END;                                      { 2nd CASE Choice OF}           END; { IF (Choice <= 100) AND (Choice >= 80) }          END        ELSE		  Begin		  BeepBeep;          putmessage('A choice was invalid. Choices must be an integer between 0 and 100', '', '', '');          end;      IF (Choice <= 100) AND (Choice >= 1)        THEN          BEGIN 					  BlockMove(@col_1^,@Plt_Spec[Spectrum]^^.S,SizeOf(Plt_Spec[Spectrum]^^.S));                      UpDate_Max_Min(Spectrum);					  SpecWork_has_been_Changed := True ;					  if (Spectrum = 10) then saved_displayed := false;					  Spectrum_Full[Spectrum] := True;					  CheckItem(FullMenu, A^.C_Full[Spectrum], Spectrum_Full[Spectrum]);					  IF  Choice = 100 then Attach_Generated_Parameters( Spectrum);						Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.BkgSubtracted := False;						Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.this_is_a_standard := false;                         	    			IF (Choice = 100) and (Running_Thin_Mode) then               begin			    Plt_spec[Spectrum]^^.Expt_Info.Number_of_Channels := theGenRec^^.number_of_Channels;				Plt_spec[Spectrum]^^.SpectrumStuff.Acq_Info.Live_Time := Live_Time;				Plt_spec[Spectrum]^^.Expt_Info.kV := Thin_KV;				Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Thickness := 				                     Specimen_Thickness;				Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Density := Thin_density; 				Plt_Spec[Spectrum]^^.SpectrumStuff.Acq_Info.Begin_Faraday := Faraday_Current;				Plt_Spec[Spectrum]^^.SpectrumStuff.Acq_Info.End_Faraday := Faraday_Current;				Plt_Spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Thickness := 				                     Specimen_Thickness;			  end;			IF (Choice = 100) and (Running_Bulk_Mode) then               begin			    Plt_spec[Spectrum]^^.Expt_Info.Number_of_Channels := theGenRec^^.number_of_Channels;				Plt_spec[Spectrum]^^.SpectrumStuff.Acq_Info.Live_Time := Live_Time;				Plt_spec[Spectrum]^^.Expt_Info.kV := Bulk_KV;				Plt_spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Density := 0.0; 				Plt_Spec[Spectrum]^^.SpectrumStuff.Acq_Info.Begin_Faraday := Faraday_Current;				Plt_Spec[Spectrum]^^.SpectrumStuff.Acq_Info.End_Faraday := Faraday_Current;					Plt_Spec[Spectrum]^^.SpectrumStuff.Spectrum_Info.Specimen_Thickness := 0.0; 			  end;					          END;                                        { if choice is not zero }    END;                                              { PROCEDURE Spectrum_Choice }End.